<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Schedule Workout — Calendar</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}</style>
</head>
<body class="bg-slate-50">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">Schedule Workout</h1>
      <a href="/frontend/index.html" class="px-4 py-2 bg-slate-700 text-white rounded-md">Dashboard</a>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- LEFT PANEL -->
      <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow">
        <form id="schedule-form" class="space-y-3">
          
          <div>
            <label class="block text-sm font-medium text-slate-700">Title</label>
            <input id="title" class="mt-1 block w-full rounded-md border px-3 py-2" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700">Date & Time</label>
            <input id="datetime" type="datetime-local" class="mt-1 block w-full rounded-md border px-3 py-2" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700">Template</label>
            <select id="template-select" class="mt-1 block w-full rounded-md border px-3 py-2">
              <option value="">— none —</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700">Notes</label>
            <textarea id="notes" class="mt-1 block w-full rounded-md border px-3 py-2" rows="3"></textarea>
          </div>

          <div class="flex gap-2">
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Schedule</button>
            <button id="clear" type="button" class="px-4 py-2 bg-slate-200 rounded-md">Clear</button>
          </div>

          <hr class="my-3" />

          <h3 class="text-sm font-semibold">Create Template</h3>

          <input id="tpl-title" placeholder="Template title" class="mt-1 block w-full rounded-md border px-3 py-2" />

          <textarea id="tpl-exercises" placeholder="One exercise per line" class="mt-1 block w-full rounded-md border px-3 py-2" rows="4"></textarea>

          <button id="create-tpl" class="mt-2 px-4 py-2 bg-emerald-600 text-white rounded-md">Create Template</button>

          <div id="tpl-msg" class="text-sm text-slate-500 mt-2"></div>

        </form>
      </div>

      <!-- RIGHT PANEL (CALENDAR) -->
      <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow">
        <div id="calendar"></div>
      </div>

    </div>
  </div>

<script>
async function fetchTemplates() {
  const resp = await fetch('/api/templates/');
  const list = await resp.json();
  const sel = document.getElementById('template-select');
  sel.innerHTML = '<option value="">— none —</option>';
  list.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = t.title;
    sel.appendChild(opt);
  });
}

async function fetchWorkouts() {
  const now = new Date();
  const from = new Date(now); from.setDate(now.getDate() - 90);
  const to = new Date(now); to.setDate(now.getDate() + 90);
  const resp = await fetch(`/api/workouts/schedule?from_dt=${from.toISOString()}&to_dt=${to.toISOString()}`);
  const arr = await resp.json();

  return arr.map(w => ({
    id: String(w.id),
    title: w.title + (w.status === "done" ? " ✅" : ""),
    start: w.scheduled_at,
    extendedProps: {
      notes: w.notes,
      status: w.status
    }
  }));
}

document.addEventListener('DOMContentLoaded', async () => {

  await fetchTemplates();

  const calEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calEl, {
    initialView: 'dayGridMonth',
    height: 700,
    headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
    selectable: true,

    dateClick(info) {
      const d = new Date(info.date);
      d.setHours(18,0,0,0);
      document.getElementById('datetime').value = d.toISOString().slice(0,16);
      window.scrollTo({top:0, behavior:'smooth'});
    },

    eventClick(info) {
      const ev = info.event;
      alert(
        ev.title +
        "\n\nNotes: " + (ev.extendedProps.notes || "—") +
        "\nStatus: " + (ev.extendedProps.status || "pending")
      );
    }
  });

  calendar.render();

  async function loadEvents() {
    calendar.removeAllEvents();
    calendar.addEventSource(await fetchWorkouts());
  }

  await loadEvents();

  document.getElementById('schedule-form').addEventListener('submit', async e => {
    e.preventDefault();
    const title = document.getElementById('title').value;
    const dt = document.getElementById('datetime').value;
    const notes = document.getElementById('notes').value;
    const templateId = document.getElementById('template-select').value || null;

    if (!title || !dt) { alert('Please add title and date/time'); return; }

    const iso = new Date(dt).toISOString();
    const resp = await fetch('/api/workouts/schedule', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ title, datetime: iso, notes, templateId })
    });

    if (resp.ok) {
      alert('Scheduled!');
      document.getElementById('title').value='';
      document.getElementById('notes').value='';
      await loadEvents();
    } else {
      alert('Error: ' + (await resp.text()));
    }
  });

  document.getElementById('clear').addEventListener('click', () => {
    document.getElementById('title').value='';
    document.getElementById('notes').value='';
    document.getElementById('datetime').value='';
  });

  document.getElementById('create-tpl').addEventListener('click', async e => {
    e.preventDefault();
    const title = document.getElementById('tpl-title').value;
    const exercises_text = document.getElementById('tpl-exercises').value;

    if (!title) {
      document.getElementById('tpl-msg').innerText='Please enter template title';
      return;
    }

    const resp = await fetch('/api/templates/', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ title, exercises_text })
    });

    if (resp.ok) {
      document.getElementById('tpl-msg').innerText='Template created!';
      document.getElementById('tpl-title').value='';
      document.getElementById('tpl-exercises').value='';
      await fetchTemplates();
    } else {
      document.getElementById('tpl-msg').innerText='Error: '+await resp.text();
    }
  });

});
</script>

</body>
</html>
