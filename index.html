<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Gym Planner — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}</style>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-6xl mx-auto p-6">

    <!-- HEADER -->
    <header class="mb-10 flex flex-col items-center text-center">
      <h1 class="text-3xl font-bold text-slate-800">Gym Planner</h1>

      <!-- ⭐ Added your name here -->
      <p class="text-sm text-slate-600 mt-1 font-semibold">By Akmal Ashique</p>

      <p class="text-sm text-slate-500 mt-1">Track workouts • Log meals • See progress</p>
    </header>

    <!-- MAIN BOXES -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <a href="/frontend/schedule.html" class="block bg-white rounded-2xl shadow-lg p-6 text-center">
        <h3 class="text-lg font-semibold text-slate-800">Schedule</h3>
        <div class="mt-4"><span class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-md">Open schedule</span></div>
      </a>

      <a href="/frontend/meals.html" class="block bg-white rounded-2xl shadow-lg p-6 text-center">
        <h3 class="text-lg font-semibold text-slate-800">Add Meal</h3>
        <div class="mt-4"><span class="inline-block px-4 py-2 bg-emerald-600 text-white rounded-md">Log meal</span></div>
      </a>

      <a href="/frontend/progress.html" class="block bg-white rounded-2xl shadow-lg p-6 text-center">
        <h3 class="text-lg font-semibold text-slate-800">Progress</h3>
        <div class="mt-4"><span class="inline-block px-4 py-2 bg-violet-600 text-white rounded-md">See progress</span></div>
      </a>
    </section>

    <!-- WORKOUTS + CALORIES -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 bg-white rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold text-slate-800 mb-3">Today's Workouts</h2>
        <div id="workouts-list" class="space-y-3 text-slate-700">
          <div class="text-sm text-slate-400">Loading…</div>
        </div>
      </section>

      <aside class="bg-white rounded-xl shadow p-6">
        <h2 class="text-lg font-semibold text-slate-800 mb-3">Today's Calories</h2>
        <div id="calories" class="text-slate-700">
          <div id="calories-total" class="text-4xl font-bold text-slate-900">— kcal</div>
          <div id="meal-list" class="mt-4 space-y-2 text-sm text-slate-600"></div>
        </div>
      </aside>
    </main>
  </div>

<script>
async function fetchWithFallback(urls, opts = {}) {
  for (const u of urls) {
    try {
      const res = await fetch(u, opts);
      if (!res.ok) continue;
      const text = await res.text();
      try { return { ok:true, json: JSON.parse(text), text }; } catch(e) { return { ok:true, text }; }
    } catch(e) { console.warn('fetch fail', u, e); }
  }
  return { ok:false };
}

function safeDateFrom(obj) {
  if (!obj) return null;
  const candidates = [obj.scheduled_at, obj.datetime, obj.performed_at, obj.created_at];
  for (const c of candidates) {
    if (!c) continue;
    const d = new Date(c);
    if (!isNaN(d)) return d;
  }
  return null;
}

async function fetchTodayWorkouts() {
  const start = new Date(); start.setHours(0,0,0,0);
  const end = new Date(); end.setHours(23,59,59,999);
  const urls = [
    `/api/workouts/schedule?from_dt=${start.toISOString()}&to_dt=${end.toISOString()}`,
    `/api/workouts?from_dt=${start.toISOString()}&to_dt=${end.toISOString()}`,
    `/api/workouts/schedule`,
    `/api/workouts`
  ];
  const container = document.getElementById('workouts-list');
  container.innerHTML = '<div class="text-sm text-slate-400">Loading…</div>';
  const res = await fetchWithFallback(urls);
  if (!res.ok) { container.innerHTML = '<div class="text-sm text-red-500">Error loading workouts</div>'; return; }
  let list = res.json ?? [];
  if (!Array.isArray(list) || list.length === 0) {
    container.innerHTML = '<div class="text-sm text-slate-500">No workouts for today.</div>';
    return;
  }
  container.innerHTML = '';
  list.forEach(w => {
    const scheduled = safeDateFrom(w);
    const timeText = scheduled ? scheduled.toLocaleString() : (w.datetime || w.scheduled_at || 'Unknown');
    const notes = w.notes || '';
    const status = w.status || 'pending';
    const id = w.id ?? null;
    const wrap = document.createElement('div');
    wrap.className = 'flex items-start justify-between gap-4 p-3 border rounded-lg hover:shadow-sm';
    wrap.innerHTML = `
      <div>
        <div class="font-medium text-slate-800">${(w.title||w.name||'Untitled')}</div>
        <div class="text-xs text-slate-500 mt-1">${timeText}</div>
        ${notes ? `<div class="text-sm text-slate-700 mt-2 whitespace-pre-wrap">${notes}</div>` : ''}
      </div>
      <div class="text-right">
        <div class="text-sm ${status==='done' ? 'text-emerald-600' : 'text-slate-600'} mb-2">${status}</div>
        <button class="px-3 py-1 rounded-md bg-indigo-600 text-white text-sm hover:bg-indigo-700" ${id ? 'onclick="markDone('+id+')"' : 'disabled'}>Mark done</button>
      </div>`;
    container.appendChild(wrap);
  });
}

async function fetchTodayMeals(){
  const res = await fetchWithFallback(['/api/meals']);
  if (!res.ok) { document.getElementById('meal-list').innerHTML = '<div class="text-sm text-red-500">Error loading meals</div>'; return; }
  let meals = res.json ?? [];
  const todayISO = new Date().toISOString().slice(0,10);
  const filtered = (Array.isArray(meals) ? meals : []).filter(m => (m.created_at||'').slice(0,10) === todayISO);
  const total = filtered.reduce((s,m)=>s + (Number(m.calories)||0), 0);
  document.getElementById('calories-total').innerText = (total || 0) + ' kcal';
  const mealsDiv = document.getElementById('meal-list'); mealsDiv.innerHTML = '';
  if (!filtered.length) { mealsDiv.innerHTML = '<div class="text-sm text-slate-400">No meals logged</div>'; return; }
  filtered.forEach(m => {
    const el = document.createElement('div'); el.className = 'flex items-center justify-between';
    el.innerHTML = `<div class="text-sm">${m.name}</div><div class="text-sm font-medium">${m.calories} kcal</div>`;
    mealsDiv.appendChild(el);
  });
}

async function markDone(id) {
  try {
    const res = await fetch(`/api/workouts/schedule/${id}?status=done`, { method: 'PATCH' });
    if (!res.ok) {
      await fetch(`/api/workouts/schedule/${id}`, { method: 'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status:'done'}) });
    }
    fetchTodayWorkouts();
  } catch(e){ console.error(e); }
}

window.onload = function(){
  fetchTodayWorkouts();
  fetchTodayMeals();
};
</script>
</body>
</html>
